{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>52WSC Chat Room - MCS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --brand: #ff6b00;
      --brand-d: #e05f00;
      --bg: #f7f7f9;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --success: #16a34a;
      --warning: #f59e0b;
      --info: #0ea5e9;
      --secondary: #64748b;
      --border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-xs: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: var(--brand);
      border-bottom: 1px solid var(--brand-d);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
      color: #fff;
      overflow: hidden;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 800;
      color: #fff;
      text-decoration: none;
    }

    .logo img {
      height: 40px;
      width: auto;
      display: block;
      object-fit: contain;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: #fff;
    }

    .user-menu {
      position: relative;
      overflow: visible;
    }

    .user-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: #fff;
      overflow: hidden;
      position: relative;
    }

    .user-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      max-width: 32px;
      max-height: 32px;
      min-width: 32px;
      min-height: 32px;
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
    }

    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
    }

    .dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: var(--text);
      text-decoration: none;
      transition: background 0.2s ease;
      border-bottom: 1px solid var(--border);
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: var(--bg);
      color: var(--brand);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: var(--card);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 999;
      overflow-y: auto;
      padding-top: 80px;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .sidebar-title i {
      color: var(--brand);
    }

    .nav-list {
      list-style: none;
      padding: 1.5rem 0;
    }

    .nav-item {
      margin-bottom: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      color: var(--muted);
      text-decoration: none;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      transition: all 0.2s ease;
      font-weight: 500;
      margin-right: 1rem;
    }

    .nav-link:hover {
      background: var(--bg);
      color: var(--text);
    }

    .nav-link.active {
      background: var(--brand);
      color: #fff;
      box-shadow: var(--shadow);
    }

    .nav-link.active i {
      color: #fff;
    }

    /* Main Content */
    .main-content {
      margin-left: 280px;
      margin-top: 80px;
      padding: 1.5rem 2rem;
      min-height: calc(100vh - 80px);
    }

    .page-header {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 1.125rem;
    }

    /* Chat Container */
    .chat-container {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .chat-title i {
      color: var(--brand);
    }

    .online-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: var(--muted);
    }

    .online-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      background: var(--bg);
    }

    .message {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.75rem;
    }

    .message.own-message {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--brand);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .message-content {
      max-width: 70%;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .message-sender {
      font-weight: 600;
      color: var(--text);
      font-size: 0.875rem;
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .message-bubble {
      background: var(--card);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      word-wrap: break-word;
    }

    .own-message .message-bubble {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .message-text {
      line-height: 1.4;
      margin: 0;
    }

    .chat-input-container {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--card);
    }

    .chat-input-form {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .input-group {
      flex: 1;
    }

    .chat-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
    }

    .send-button {
      padding: 0.75rem 1.5rem;
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 44px;
    }

    .send-button:hover {
      background: var(--brand-d);
      transform: translateY(-1px);
    }

    .send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Welcome Message */
    .welcome-message {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }

    .welcome-message i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .welcome-message h3 {
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .mobile-menu-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }
      
      .page-header {
        padding: 1.5rem;
      }
      
      .page-title {
        font-size: 1.75rem;
      }
      
      .chat-container {
        height: calc(100vh - 180px);
      }
      
      .chat-header {
        padding: 1rem;
      }
      
      .chat-messages {
        padding: 1rem;
      }
      
      .chat-input-container {
        padding: 1rem;
      }
      
      .chat-input-form {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .send-button {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .header-content {
        padding: 0.75rem 1rem;
      }
      
      .main-content {
        padding: 0.75rem;
      }
      
      .page-header {
        padding: 1rem;
      }
      
      .page-title {
        font-size: 1.5rem;
      }
      
      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <a href="{% url 'landing' %}" class="logo">
        <img src="{% static 'core/images/logo.png' %}" alt="MCS Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
        <span class="logo-text">MCS</span>
      </a>
      
      <div class="user-menu">
        <button class="user-button" id="userButton">
          <div class="user-avatar">
            {% if user.profile.photo %}
              <img src="{{ user.profile.photo.url }}" alt="Profile Photo">
            {% else %}
              {{ user.profile.initials|default:user.username|first|upper }}
            {% endif %}
          </div>
          <span>{{ user.first_name|title|default:user.get_username|title }}</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        
        <div class="dropdown" id="userDropdown">
          <a href="{% url 'profile' %}" class="dropdown-item">
            <i class="fas fa-user"></i>
            Profile
          </a>
          <a href="{% url 'landing' %}" class="dropdown-item">
            <i class="fas fa-home"></i>
            Dashboard
          </a>
          <a href="{% url 'accounts:logout' %}" class="dropdown-item">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">
        <i class="fas fa-wallet"></i>
        52 Weeks Savings
      </h2>
    </div>
    
    <ul class="nav-list">
      <li class="nav-item">
        <a href="{% url 'savings_52_weeks:group_dashboard' %}" class="nav-link">
          <i class="fas fa-home"></i>
          Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'savings_52_weeks:member_dashboard' %}" class="nav-link">
          <i class="fas fa-wallet"></i>
          Personal Transactions
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'savings_52_weeks:report' %}" class="nav-link">
          <i class="fas fa-chart-bar"></i>
          Reports
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'savings_52_weeks:chat_room' %}" class="nav-link active">
          <i class="fas fa-comments"></i>
          Chat Room
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">52WSC <span style="color: var(--brand);">Group Chat</span></h1>
      <p class="page-subtitle">Connect with your fellow 52 Weeks Savings Challenge members</p>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-title">
          <i class="fas fa-users"></i>
          52WSC Group Chat
        </div>
        <div class="online-indicator">
          <div class="online-dot"></div>
          <span id="onlineCount">0</span> members online
        </div>
      </div>

      <!-- Chat Messages -->
      <div class="chat-messages" id="chatMessages">
        <!-- Welcome Message -->
        <div class="welcome-message">
          <i class="fas fa-comments"></i>
          <h3>Welcome to the 52WSC Group Chat!</h3>
          <p>Start chatting with your fellow members. Share tips, ask questions, and stay motivated together!</p>
        </div>
        
        <!-- Messages will be dynamically added here -->
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <form class="chat-input-form" id="chatForm">
          <div class="input-group">
            <textarea 
              class="chat-input" 
              id="messageInput" 
              placeholder="Type your message here..." 
              rows="1"
              maxlength="500"
            ></textarea>
          </div>
          <button type="submit" class="send-button" id="sendButton">
            <i class="fas fa-paper-plane"></i>
            Send
          </button>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Chat functionality
    class GroupChat {
      constructor() {
        this.messages = [];
        this.currentUser = {
          name: '{{ user.first_name|title|default:user.username|title }}',
          username: '{{ user.username }}',
          initials: '{{ user.profile.initials|default:user.username|first|upper }}'
        };
        this.onlineCount = 0;
        this.init();
      }

      init() {
        this.bindEvents();
        this.loadMockMessages();
        this.updateOnlineCount();
        this.autoResizeInput();
      }

      bindEvents() {
        const form = document.getElementById('chatForm');
        const input = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.sendMessage();
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // User dropdown functionality
        const userButton = document.getElementById('userButton');
        const userDropdown = document.getElementById('userDropdown');
        
        userButton.addEventListener('click', () => {
          userDropdown.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
          if (!userButton.contains(e.target)) {
            userDropdown.classList.remove('show');
          }
        });

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        
        mobileMenuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
          if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
            sidebar.classList.remove('show');
          }
        });

        // Close mobile menu on window resize
        window.addEventListener('resize', () => {
          if (window.innerWidth > 1024) {
            sidebar.classList.remove('show');
          }
        });
      }

      sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message) return;

        const newMessage = {
          id: Date.now(),
          sender: this.currentUser.name,
          username: this.currentUser.username,
          initials: this.currentUser.initials,
          text: message,
          timestamp: new Date(),
          isOwn: true
        };

        this.addMessage(newMessage);
        input.value = '';
        input.style.height = 'auto';
        
        // Simulate other members typing (for demo purposes)
        setTimeout(() => {
          this.simulateTyping();
        }, 1000 + Math.random() * 2000);
      }

      addMessage(message) {
        this.messages.push(message);
        this.renderMessage(message);
        this.scrollToBottom();
      }

      renderMessage(message) {
        const messagesContainer = document.getElementById('chatMessages');
        const welcomeMessage = messagesContainer.querySelector('.welcome-message');
        
        // Remove welcome message after first real message
        if (welcomeMessage && this.messages.length > 1) {
          welcomeMessage.remove();
        }

        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.isOwn ? 'own-message' : ''}`;
        messageElement.innerHTML = `
          <div class="message-avatar">
            ${message.initials}
          </div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">${message.sender}</span>
              <span class="message-time">${this.formatTime(message.timestamp)}</span>
            </div>
            <div class="message-bubble">
              <p class="message-text">${this.escapeHtml(message.text)}</p>
            </div>
          </div>
        `;

        messagesContainer.appendChild(messageElement);
      }

      simulateTyping() {
        const mockResponses = [
          "Great progress everyone! Keep it up! ðŸ’ª",
          "Anyone have tips for staying consistent with weekly savings?",
          "The 52-week challenge is really helping me build discipline!",
          "Just completed week 25! Halfway there! ðŸŽ‰",
          "Remember, every small amount adds up over time!",
          "Has anyone tried the investment options yet?",
          "This group is so motivating! Thank you all! ðŸ™",
          "Week 30 here we come! Let's keep pushing!",
          "The compound effect is amazing to watch! ðŸ“ˆ",
          "Stay focused on the goal, everyone! We've got this!"
        ];

        const randomResponse = mockResponses[Math.floor(Math.random() * mockResponses.length)];
        const mockUsers = [
          { name: 'Sarah', initials: 'S' },
          { name: 'Michael', initials: 'M' },
          { name: 'Emma', initials: 'E' },
          { name: 'David', initials: 'D' },
          { name: 'Lisa', initials: 'L' }
        ];

        const randomUser = mockUsers[Math.floor(Math.random() * mockUsers.length)];
        
        const mockMessage = {
          id: Date.now(),
          sender: randomUser.name,
          username: randomUser.name.toLowerCase(),
          initials: randomUser.initials,
          text: randomResponse,
          timestamp: new Date(),
          isOwn: false
        };

        this.addMessage(mockMessage);
      }

      loadMockMessages() {
        // Add a few initial messages to make the chat feel active
        const initialMessages = [
          {
            id: 1,
            sender: 'Admin',
            username: 'admin',
            initials: 'A',
            text: 'Welcome to the 52WSC Group Chat! Feel free to introduce yourselves and share your progress.',
            timestamp: new Date(Date.now() - 300000), // 5 minutes ago
            isOwn: false
          },
          {
            id: 2,
            sender: 'John',
            username: 'john',
            initials: 'J',
            text: 'Hi everyone! I\'m starting week 15. This challenge is really helping me save consistently!',
            timestamp: new Date(Date.now() - 180000), // 3 minutes ago
            isOwn: false
          }
        ];

        initialMessages.forEach(msg => this.addMessage(msg));
      }

      updateOnlineCount() {
        // Simulate online count (in real app, this would come from backend)
        this.onlineCount = Math.floor(Math.random() * 15) + 8; // 8-22 members
        document.getElementById('onlineCount').textContent = this.onlineCount;
        
        // Update every 30 seconds
        setInterval(() => {
          this.onlineCount = Math.floor(Math.random() * 15) + 8;
          document.getElementById('onlineCount').textContent = this.onlineCount;
        }, 30000);
      }

      scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      autoResizeInput() {
        const input = document.getElementById('messageInput');
        input.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
      }

      formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        
        return date.toLocaleDateString();
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Initialize chat when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new GroupChat();
    });
  </script>
</body>
</html>

