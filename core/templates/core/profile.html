{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - MCS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --brand: #ff6b00;
      --brand-d: #e05f00;
      --bg: #f7f7f9;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --success: #16a34a;
      --warning: #f59e0b;
      --info: #0ea5e9;
      --secondary: #64748b;
      --border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-xs: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Header */
         .header {
       background: var(--brand);
       border-bottom: 1px solid var(--brand-d);
       position: fixed;
       top: 0;
       left: 0;
       right: 0;
       z-index: 1000;
       box-shadow: var(--shadow);
       color: #fff;
       overflow: visible;
     }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
      font-weight: 800;
      color: #fff;
      text-decoration: none;
    }

    .logo img {
      height: 40px;
      width: auto;
      display: block;
      object-fit: contain;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: #fff;
    }

         .user-menu {
       position: relative;
       overflow: visible;
       z-index: 1002;
     }

         .user-button {
       display: flex;
       align-items: center;
       gap: 0.5rem;
       background: rgba(255, 255, 255, 0.2);
       border: 1px solid rgba(255, 255, 255, 0.3);
       border-radius: var(--radius-sm);
       padding: 0.5rem 1rem;
       cursor: pointer;
       transition: all 0.2s ease;
       font-weight: 500;
       color: #fff;
       overflow: hidden;
       position: relative;
     }

    .user-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

         .user-avatar {
       width: 32px;
       height: 32px;
       background: rgba(255, 255, 255, 0.3);
       border-radius: 50%;
       display: flex;
       align-items: center;
       justify-content: center;
       color: #fff;
       font-weight: 600;
       overflow: hidden;
       position: relative;
       flex-shrink: 0;
     }
     
     .user-avatar img {
       width: 100%;
       height: 100%;
       border-radius: 50%;
       object-fit: cover;
       max-width: 32px;
       max-height: 32px;
       min-width: 32px;
       min-height: 32px;
       display: block;
       position: absolute;
       top: 0;
       left: 0;
       z-index: 2;
     }

    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      z-index: 10000;
    }

    .dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: var(--text);
      text-decoration: none;
      transition: background 0.2s ease;
      border-bottom: 1px solid var(--border);
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: var(--bg);
      color: var(--brand);
    }

    /* Main Content */
         .main-content {
       margin-top: 80px;
       padding: 2rem;
       max-width: 1200px;
       margin-left: auto;
       margin-right: auto;
       position: relative;
       z-index: 1;
     }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 1.1rem;
    }

    /* Profile Grid - 3 columns: Profile Info | Projects | Action Requests */
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1.4fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
      align-items: start;
    }

    /* Profile Information Accordions */
    .profile-info-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .profile-info-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      padding: 1.25rem 1.5rem;
      border-bottom: 2px solid var(--border);
      background: var(--bg);
    }

    .accordion-section {
      border-bottom: 1px solid var(--border);
    }

    .accordion-section:last-child {
      border-bottom: none;
    }

    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      cursor: pointer;
      background: var(--card);
      transition: background 0.2s;
      user-select: none;
    }

    .accordion-header:hover {
      background: var(--bg);
    }

    .accordion-header.active {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .accordion-header-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .accordion-header-title i {
      color: var(--brand);
      width: 1.25rem;
    }

    .accordion-chevron {
      transition: transform 0.2s;
      color: var(--muted);
    }

    .accordion-header.active .accordion-chevron {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.show {
      max-height: 2000px;
    }

    .accordion-body {
      padding: 1rem 1.5rem 1.5rem;
      background: var(--bg);
      border-top: none;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--muted);
      font-weight: 500;
    }

    .info-value {
      color: var(--text);
      text-align: right;
    }

    .section-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Projects Section (Center) */
    .projects-section {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Action Requests Panel (Right) */
    .action-requests-panel {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: sticky;
      top: 1rem;
    }
    .action-requests-panel .panel-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
      padding: 1.25rem 1.25rem;
      border-bottom: 2px solid var(--border);
      background: var(--bg);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .action-requests-panel .panel-title i {
      color: var(--brand);
    }
    .action-requests-list {
      padding: 1rem;
      max-height: 520px;
      overflow-y: auto;
    }
    .action-request-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 0.9rem 1rem;
      margin-bottom: 0.65rem;
      border-left: 4px solid var(--border);
      transition: all 0.2s ease;
    }
    .action-request-card:last-child {
      margin-bottom: 0;
    }
    .action-request-card.project-52wsc { border-left-color: #f59e0b; }
    .action-request-card.project-cgf { border-left-color: #16a34a; }
    .action-request-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .action-request-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }
    .action-request-type {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
    }
    .action-request-type i {
      color: var(--brand);
      font-size: 0.8rem;
    }
    .action-request-project {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      background: rgba(255, 107, 0, 0.1);
      color: var(--brand);
    }
    .action-request-project.cgf {
      background: rgba(22, 163, 74, 0.1);
      color: #16a34a;
    }
    .action-request-detail {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    .action-request-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .action-request-date {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .action-request-status {
      padding: 0.2rem 0.55rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .action-request-status.pending { background: rgba(245, 158, 11, 0.2); color: #b45309; }
    .action-request-status.approved { background: rgba(34, 197, 94, 0.2); color: #15803d; }
    .action-request-status.processed { background: rgba(59, 130, 246, 0.2); color: #1d4ed8; }
    .action-request-status.rejected { background: rgba(239, 68, 68, 0.2); color: #b91c1c; }
    .action-requests-empty {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .action-requests-empty i {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }

    .projects-section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      padding: 1.25rem 1.5rem;
      border-bottom: 2px solid var(--border);
      background: var(--bg);
    }

    .project-cards-container {
      padding: 1.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .project-card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .project-card:hover {
      border-color: var(--brand);
      box-shadow: 0 6px 20px rgba(255, 107, 0, 0.12);
      transform: translateY(-2px);
    }

    .project-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      background: linear-gradient(135deg, var(--brand), var(--brand-d));
      color: #fff;
      gap: 0.75rem;
    }

    .project-card-header-inner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 0;
    }

    .project-card-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--radius-xs);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .project-card-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-card-link {
      color: rgba(255,255,255,0.95);
      font-size: 0.8rem;
      text-decoration: none;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .project-card-link:hover {
      color: #fff;
      text-decoration: underline;
    }

    .project-card-body {
      padding: 1rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* 52WSC: stats as list with label-value format */
    .project-stats-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .project-stats-list-orange {
      background: rgba(255, 107, 0, 0.08);
      padding: 0.875rem 1rem;
      border-radius: var(--radius-xs);
      border: 1px solid rgba(255, 107, 0, 0.15);
    }

    .project-stat-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.5rem;
      min-height: 1.5em;
    }

    .project-stat-row .project-stat-label {
      color: var(--muted);
      flex-shrink: 0;
    }

    .project-stat-row .project-stat-label-stacked {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
    }

    .project-stat-row .project-stat-sublabel {
      font-size: 0.75em;
      opacity: 0.9;
    }

    .project-stat-row .project-stat-value {
      font-weight: 700;
      color: var(--brand);
      flex-shrink: 0;
      margin-bottom: 0;
    }

    .project-stat-row .project-stat-value.project-stat-value-interest {
      color: var(--success);
    }

    .project-stat-row-block {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.35rem;
    }

    .project-stat-row-block .project-stat-farms {
      font-size: 0.85rem;
      color: var(--text);
    }

    .project-stat-farm-item {
      display: inline;
    }

    .project-stat-muted {
      color: var(--muted);
      font-style: italic;
    }

    .project-stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .project-stat {
      background: var(--bg);
      padding: 0.5rem 0.6rem;
      border-radius: var(--radius-xs);
      text-align: center;
    }

    .project-stat-value {
      font-weight: 700;
      color: var(--brand);
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.15rem;
    }

    .project-stat-label {
      color: var(--muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .project-requests {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(251, 146, 60, 0.3);
    }
    .project-requests-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .project-requests-title i {
      font-size: 0.7rem;
      color: var(--brand);
    }
    .project-request-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.35rem;
      padding: 0.4rem 0;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--border);
    }
    .project-request-item:last-child {
      border-bottom: none;
    }
    .project-request-type {
      color: var(--text);
      font-weight: 500;
    }
    .project-request-detail {
      color: var(--muted);
      font-size: 0.75rem;
    }
    .project-request-status {
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .project-request-status.pending { background: rgba(245, 158, 11, 0.2); color: #b45309; }
    .project-request-status.approved { background: rgba(34, 197, 94, 0.2); color: #15803d; }
    .project-request-status.processed { background: rgba(59, 130, 246, 0.2); color: #1d4ed8; }
    .project-request-status.rejected { background: rgba(239, 68, 68, 0.2); color: #b91c1c; }

    .project-actions-compact {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: auto;
    }

    .project-action-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-xs);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      width: 100%;
    }

    .project-action-btn:hover {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .project-action-btn i {
      font-size: 0.85rem;
      width: 1rem;
      color: var(--brand);
    }

    .project-action-btn:hover i {
      color: #fff;
    }

    .project-action-coming-soon {
      cursor: default;
      opacity: 0.6;
      pointer-events: none;
    }

    .project-placeholder {
      text-align: center;
      padding: 1.5rem 1rem;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .project-placeholder i {
      font-size: 2rem;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }

    .project-farms-list {
      font-size: 0.8rem;
      color: var(--muted);
      max-height: 2.5em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Profile Card */
         .profile-card {
       background: var(--card);
       border-radius: var(--radius);
       box-shadow: var(--shadow);
       overflow: hidden;
       position: relative;
       z-index: 1;
     }

         .profile-header {
       background: linear-gradient(135deg, var(--brand), var(--brand-d));
       color: #fff;
       padding: 2rem;
       text-align: center;
       position: relative;
       overflow: hidden;
       z-index: 1;
     }

         .profile-avatar {
       width: 120px;
       height: 120px;
       border-radius: 50%;
       margin: 0 auto 1rem;
       background: rgba(255, 255, 255, 0.2);
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 3rem;
       color: #fff;
       font-weight: 700;
       border: 4px solid rgba(255, 255, 255, 0.3);
       overflow: hidden;
       position: relative;
       flex-shrink: 0;
     }

         .profile-avatar img {
       width: 100%;
       height: 100%;
       border-radius: 50%;
       object-fit: cover;
       max-width: 120px;
       max-height: 120px;
       min-width: 120px;
       min-height: 120px;
       display: block;
       position: absolute;
       top: 0;
       left: 0;
     }

    .profile-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .profile-username {
      opacity: 0.9;
      font-size: 1rem;
    }

    .profile-stats {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Balance & Withheld Amounts Section */
    .balance-section {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .available-balance-card {
      background: linear-gradient(135deg, var(--success), #14b8a6);
      border-radius: var(--radius);
      padding: 1.5rem;
      color: #fff;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.2);
    }

    .balance-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .balance-header i {
      font-size: 1.5rem;
    }

    .balance-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
      opacity: 0.95;
    }

    .balance-amount {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: -0.5px;
    }

    .balance-description {
      font-size: 0.875rem;
      opacity: 0.9;
      margin: 0;
    }

    .withheld-amounts-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .withheld-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .withheld-header i {
      font-size: 1.25rem;
      color: var(--warning);
    }

    .withheld-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
      color: var(--text);
    }

    .withheld-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .withheld-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
    }

    .withheld-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .withheld-item-icon.withdraw {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .withheld-item-icon.gwc {
      background: rgba(14, 165, 233, 0.1);
      color: var(--info);
    }

    .withheld-item-icon.mesu {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
    }

    .withheld-item-content {
      flex: 1;
    }

    .withheld-item-label {
      font-size: 0.875rem;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }

    .withheld-item-amount {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
    }

    .withheld-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-top: 0.5rem;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
      border-radius: var(--radius-sm);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .withheld-total-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }

    .withheld-total-amount {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--warning);
    }

    /* Savings Actions Section */
    .profile-actions {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    .actions-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .actions-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--brand);
      border-radius: 2px;
    }

    .actions-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.25rem;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      width: 100%;
      position: relative;
    }

    .action-btn:hover {
      border-color: var(--brand);
      box-shadow: 0 4px 12px rgba(255, 107, 0, 0.15);
      transform: translateY(-2px);
    }

    .action-icon {
      width: 50px;
      height: 50px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #fff;
      flex-shrink: 0;
    }

    .action-withdraw .action-icon {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .action-gwc .action-icon {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .action-mesu .action-icon {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .action-content {
      flex: 1;
      min-width: 0;
    }

    .action-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .action-description {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0;
      line-height: 1.4;
    }

    .action-arrow {
      color: var(--muted);
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .action-btn:hover .action-arrow {
      color: var(--brand);
      transform: translateX(4px);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal-title i {
      color: var(--brand);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--muted);
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
      transition: color 0.2s ease;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      background: var(--bg);
      border-radius: 0 0 var(--radius) var(--radius);
    }

    /* Profile Projects Section */
    .profile-projects {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    .projects-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .projects-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--brand);
      border-radius: 2px;
    }

    .projects-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .project-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--card);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }

         .project-item:hover {
       border-color: var(--brand);
       box-shadow: 0 2px 8px rgba(255, 107, 0, 0.1);
     }
     
     .project-item.clickable {
       cursor: pointer;
       transition: all 0.2s ease;
     }
     
     .project-item.clickable:hover {
       transform: translateY(-2px);
       box-shadow: 0 4px 12px rgba(255, 107, 0, 0.15);
     }

    .project-icon {
      width: 40px;
      height: 40px;
      background: var(--brand);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .project-info {
      flex: 1;
      min-width: 0;
    }

    .project-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-description {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .no-projects {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--muted);
    }

    .no-projects i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .no-projects p {
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .no-projects small {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* Project Access Information */
    .project-access-info {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 1rem;
    }

    .access-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .access-count {
      font-weight: 600;
      color: var(--text);
    }

    .project-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .project-tag {
      background: var(--brand);
      color: #fff;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-xs);
      font-size: 0.8rem;
      font-weight: 500;
    }

    .no-access {
      text-align: center;
      padding: 1rem;
    }

    .no-access small {
      display: block;
      margin-top: 0.5rem;
      color: var(--muted);
      font-size: 0.8rem;
    }

    /* Quick Access Section */
    .quick-access {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--card);
    }

    .quick-access-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .quick-access-title::before {
      content: '';
      width: 3px;
      height: 16px;
      background: var(--brand);
      border-radius: 1.5px;
    }

    .quick-access-links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .quick-access-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
      color: var(--text);
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .quick-access-link:hover {
      background: var(--brand);
      color: #fff;
      transform: translateX(4px);
    }

    .quick-access-link i {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* Profile Details */
    .profile-details {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: all 0.2s ease;
      background: var(--card);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
    }

    .form-control[readonly] {
      background: var(--bg);
      color: var(--muted);
      cursor: not-allowed;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .form-help {
      font-size: 0.875rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--brand);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--brand-d);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: #fff;
    }

    .btn-secondary:hover {
      background: var(--muted);
    }

    .btn-outline {
      background: transparent;
      color: var(--brand);
      border: 2px solid var(--brand);
    }

    .btn-outline:hover {
      background: var(--brand);
      color: #fff;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .profile-grid {
        grid-template-columns: 1fr 1fr;
      }
      .action-requests-panel {
        grid-column: 1 / -1;
      }
    }

    @media (max-width: 768px) {
      .profile-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .profile-info-card {
        order: 1;
      }

      .projects-section {
        order: 2;
      }

      .action-requests-panel {
        order: 3;
        position: static;
      }

      .project-cards-container {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .main-content {
        padding: 1rem;
      }

      .profile-header {
        padding: 1.5rem;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
      }

      .form-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .profile-projects {
        padding: 1rem;
      }

      .project-item {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }

      .project-icon {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }

      .quick-access {
        padding: 1rem;
      }

      .quick-access-links {
        gap: 0.75rem;
      }

      .quick-access-link {
        justify-content: center;
      }
    }

    /* Status Indicators */
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: var(--radius-xs);
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-success { background: rgba(22, 163, 74, 0.15); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .badge-info { background: rgba(14, 165, 233, 0.15); color: var(--info); }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-xs);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-verified {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .status-admin {
      background: rgba(14, 165, 233, 0.1);
      color: var(--info);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    /* Notification System */
    .notification-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 400px;
    }

    .notification {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 1.25rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      animation: slideInRight 0.3s ease-out;
      border-left: 4px solid;
      position: relative;
      overflow: hidden;
    }

    .notification.success {
      border-left-color: var(--success);
      background: linear-gradient(to right, rgba(22, 163, 74, 0.05), var(--card));
    }

    .notification.error {
      border-left-color: #ef4444;
      background: linear-gradient(to right, rgba(239, 68, 68, 0.05), var(--card));
    }

    .notification.warning {
      border-left-color: var(--warning);
      background: linear-gradient(to right, rgba(245, 158, 11, 0.05), var(--card));
    }

    .notification.info {
      border-left-color: var(--info);
      background: linear-gradient(to right, rgba(14, 165, 233, 0.05), var(--card));
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .notification.hiding {
      animation: slideOutRight 0.3s ease-out forwards;
    }

    .notification-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .notification.success .notification-icon {
      color: var(--success);
    }

    .notification.error .notification-icon {
      color: #ef4444;
    }

    .notification.warning .notification-icon {
      color: var(--warning);
    }

    .notification.info .notification-icon {
      color: var(--info);
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
      color: var(--text);
    }

    .notification-message {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .notification-close {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--muted);
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
      transition: color 0.2s;
    }

    .notification-close:hover {
      color: var(--text);
    }

    .notification-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: currentColor;
      opacity: 0.3;
      animation: progressBar 10s linear forwards;
    }

    @keyframes progressBar {
      from {
        width: 100%;
      }
      to {
        width: 0%;
      }
    }

    /* Required Fields Warning Banner */
    .required-fields-banner {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff;
      padding: 1.25rem 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      }
      50% {
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5);
      }
    }

    .required-fields-banner i {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .required-fields-content {
      flex: 1;
    }

    .required-fields-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .required-fields-list {
      font-size: 0.95rem;
      opacity: 0.95;
      margin-top: 0.5rem;
    }

    .required-fields-list strong {
      font-weight: 600;
    }

    .required-fields-banner .btn-close-banner {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      padding: 0.5rem;
      border-radius: var(--radius-xs);
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .required-fields-banner .btn-close-banner:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="{% url 'landing' %}" class="logo">
        <img src="{% static 'core/images/logo.png' %}" alt="MCS Logo" onerror="this.style.display='none'">
        <span class="logo-text">MCS</span>
      </a>
      
      <div class="user-menu">
        <button class="user-button" onclick="toggleDropdown()">
          <div class="user-avatar">
            {% if user.profile.photo %}
              <img src="{{ user.profile.photo.url }}" alt="Profile Photo">
            {% else %}
              {{ user.profile.initials|default:user.username|first|upper }}
            {% endif %}
          </div>
          <span>{{ user.first_name|default:user.get_username }}</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        
        <div class="dropdown" id="userDropdown">
          <a href="{% url 'landing' %}" class="dropdown-item">
            <i class="fas fa-home"></i>
            Dashboard
          </a>
          <a href="{% url 'profile' %}" class="dropdown-item">
            <i class="fas fa-user"></i>
            Profile
          </a>
          <a href="{% url 'accounts:logout' %}" class="dropdown-item">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">{{ user.first_name|title|default:user.get_username|title }}'s Profile</h1>
      <p class="page-subtitle">Manage your account information and preferences</p>
    </div>

    <!-- Required Fields Warning Banner -->
    {% if has_missing_fields %}
    <div class="required-fields-banner" id="requiredFieldsBanner">
      <i class="fas fa-exclamation-triangle"></i>
      <div class="required-fields-content">
        <div class="required-fields-title">⚠️ Complete Your Profile</div>
        <div class="required-fields-list">
          Please provide the following information to use all features:
          <strong>{{ missing_fields|join:", " }}</strong>
        </div>
      </div>
      <button type="button" class="btn-close-banner" onclick="document.getElementById('requiredFieldsBanner').style.display='none'">
        <i class="fas fa-times"></i>
      </button>
    </div>
    {% endif %}

    <!-- Django Messages Display -->
    {% if messages %}
      {% for message in messages %}
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            showNotification('{{ message.tags|default:"info" }}', '{{ message|escapejs }}');
          });
        </script>
      {% endfor %}
    {% endif %}

    <!-- Profile Grid -->
    <div class="profile-grid">
      <!-- LEFT: Profile Information -->
      <div class="profile-info-card">
        <h3 class="profile-info-title">Profile Information</h3>

        <!-- Personal Information -->
        <div class="accordion-section">
          <div class="accordion-header active" onclick="toggleAccordion(this)">
            <span class="accordion-header-title"><i class="fas fa-user"></i> Personal Information</span>
            <i class="fas fa-chevron-down accordion-chevron"></i>
          </div>
          <div class="accordion-content show">
            <div class="accordion-body">
              <div class="info-row">
                <span class="info-label">Name</span>
                <span class="info-value">{{ user.first_name }} {{ user.last_name }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Username</span>
                <span class="info-value">@{{ user.get_username }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Email</span>
                <span class="info-value">{{ user.email|default:"—" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Account Number</span>
                <span class="info-value">{{ user.profile.account_number|default:"Not assigned" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Member Since</span>
                <span class="info-value">{{ user.profile.created_at|date:"F j, Y" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">WhatsApp</span>
                <span class="info-value">{{ user.profile.whatsapp_number|default:"—" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">National ID</span>
                <span class="info-value">{{ user.profile.national_id|default:"—" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Address</span>
                <span class="info-value">{{ user.profile.address|default:"—"|truncatewords:10 }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Birthdate</span>
                <span class="info-value">{{ user.profile.birthdate|date:"M d, Y"|default:"—" }}</span>
              </div>
              <div class="section-actions">
                <button type="button" class="btn btn-primary btn-sm" onclick="openEditPersonalModal()">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Share Holding Summary -->
        <div class="accordion-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span class="accordion-header-title"><i class="fas fa-chart-pie"></i> Share Holding Summary</span>
            <i class="fas fa-chevron-down accordion-chevron"></i>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              {% if mesu_interests %}
                <div class="info-row">
                  <span class="info-label">Total Shares (Approved)</span>
                  <span class="info-value">{{ mesu_total_shares }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Total Invested</span>
                  <span class="info-value">UGX {{ mesu_total_invested|floatformat:0|intcomma }}</span>
                </div>
                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--muted);">Holdings by status:</div>
                <div style="margin-top: 0.5rem; max-height: 200px; overflow-y: auto;">
                  <table style="width: 100%; font-size: 0.85rem; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 2px solid var(--border);">
                        <th style="text-align: left; padding: 0.5rem;">Shares</th>
                        <th style="text-align: right; padding: 0.5rem;">Amount</th>
                        <th style="text-align: center; padding: 0.5rem;">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for m in mesu_interests %}
                      <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.5rem;">{{ m.number_of_shares }}</td>
                        <td style="text-align: right; padding: 0.5rem;">UGX {{ m.investment_amount|floatformat:0|intcomma }}</td>
                        <td style="text-align: center; padding: 0.5rem;">
                          <span class="badge {% if m.status == 'approved' %}badge-success{% elif m.status == 'processed' %}badge-info{% else %}badge-warning{% endif %}" style="font-size: 0.75rem;">{{ m.get_status_display }}</span>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p style="color: var(--muted); margin: 0;">This feature of the app is under development.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Bank Account Details -->
        <div class="accordion-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span class="accordion-header-title"><i class="fas fa-university"></i> Bank Account Details</span>
            <i class="fas fa-chevron-down accordion-chevron"></i>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="info-row">
                <span class="info-label">Bank Name</span>
                <span class="info-value">{{ user.profile.bank_name|default:"—" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Account Number</span>
                <span class="info-value">{{ user.profile.bank_account_number|default:"—" }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Account Name</span>
                <span class="info-value">{{ user.profile.bank_account_name|default:"—" }}</span>
              </div>
              <div class="section-actions">
                <button type="button" class="btn btn-primary btn-sm" onclick="openEditBankModal()">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER: My Projects -->
      <div class="projects-section">
        <h3 class="projects-section-title">My Projects</h3>
        <div class="project-cards-container">
          {% if user_projects %}
            <!-- 52 Weeks Saving Challenge -->
            {% if has_52wsc %}
            <div class="project-card">
              <div class="project-card-header">
                <div class="project-card-header-inner">
                  <div class="project-card-icon"><i class="fas fa-piggy-bank"></i></div>
                  <h4 class="project-card-title">52 Weeks Saving Challenge</h4>
                </div>
                <a href="{% url 'savings_52_weeks:member_dashboard' %}" class="project-card-link">Open <i class="fas fa-external-link-alt"></i></a>
              </div>
              <div class="project-card-body">
                <div class="project-stats-list project-stats-list-orange">
                  <div class="project-stat-row"><span class="project-stat-label">Saved ({% now "Y" %}):</span><span class="project-stat-value">UGX {{ w52_current_year_saved|default:0|floatformat:0|intcomma }}</span></div>
                  <div class="project-stat-row"><span class="project-stat-label">Interest Earned:</span><span class="project-stat-value project-stat-value-interest">UGX {{ w52_interest_ytd|default:0|floatformat:0|intcomma }}</span></div>
                  <div class="project-stat-row"><span class="project-stat-label project-stat-label-stacked"><span>Available:</span><span class="project-stat-sublabel">(for withdraw)</span></span><span class="project-stat-value">UGX {{ w52_available_balance|default:0|floatformat:0|intcomma }}</span></div>
                </div>
                <div class="project-actions-compact">
                  <button type="button" class="project-action-btn" onclick="openWithdrawModal()"><i class="fas fa-money-bill-wave"></i> Withdraw</button>
                  <button type="button" class="project-action-btn" onclick="openGWCModal()"><i class="fas fa-users"></i> Join GWC Group</button>
                  <button type="button" class="project-action-btn" onclick="openMESUModal()"><i class="fas fa-graduation-cap"></i> Buy MESU Shares</button>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Commercial Goat Farming -->
            {% if has_cgf %}
            <div class="project-card">
              <div class="project-card-header">
                <div class="project-card-header-inner">
                  <div class="project-card-icon"><i class="fas fa-horse"></i></div>
                  <h4 class="project-card-title">Commercial Goat Farming</h4>
                </div>
                <a href="{% url 'goat_farming:dashboard' %}" class="project-card-link">Open <i class="fas fa-external-link-alt"></i></a>
              </div>
              <div class="project-card-body">
                <div class="project-stats-list project-stats-list-orange">
                  <div class="project-stat-row"><span class="project-stat-label">Amount invested:</span><span class="project-stat-value">UGX {{ cgf_total_invested|floatformat:0|intcomma }}</span></div>
                  <div class="project-stat-row"><span class="project-stat-label">Expected kids:</span><span class="project-stat-value project-stat-value-interest">{{ cgf_expected_kids }}</span></div>
                  <div class="project-stat-row project-stat-row-block">
                    <span class="project-stat-label">Completed cycles by farm:</span>
                    <span class="project-stat-farms">
                      {% if cgf_farms_with_goats %}
                        {% for farm_name, total_at_maturity in cgf_farms_with_goats %}
                        <span class="project-stat-farm-item">{{ farm_name }}: {{ total_at_maturity }} goats</span>{% if not forloop.last %} · {% endif %}
                        {% endfor %}
                      {% else %}
                        <span class="project-stat-muted">No goats allocated yet</span>
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="project-actions-compact">
                  {% if cgf_has_completed_cycles %}
                  <button type="button" class="project-action-btn" onclick="openCGFSellModal()"><i class="fas fa-hand-holding-usd"></i> Sell & Cash Out</button>
                  <button type="button" class="project-action-btn" onclick="openCGFTakeGoatsModal()"><i class="fas fa-truck-loading"></i> Take Goats</button>
                  <button type="button" class="project-action-btn" onclick="openCGFTransferModal()"><i class="fas fa-exchange-alt"></i> Transfer (Breeding → Commercial)</button>
                  {% else %}
                  <span class="project-action-btn project-action-coming-soon" title="Complete a 14‑month cycle first"><i class="fas fa-hand-holding-usd"></i> Sell & Cash Out</span>
                  <span class="project-action-btn project-action-coming-soon" title="Complete a 14‑month cycle first"><i class="fas fa-truck-loading"></i> Take Goats</span>
                  <span class="project-action-btn project-action-coming-soon" title="Complete a 14‑month cycle first"><i class="fas fa-exchange-alt"></i> Transfer (Breeding → Commercial)</span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Other projects -->
            {% for project in user_projects %}
              {% if project.name != '52 Weeks Saving Challenge' and project.name != 'Commercial Goat Farming' %}
            <div class="project-card">
              <div class="project-card-header">
                <div class="project-card-header-inner">
                  <div class="project-card-icon"><i class="fas fa-folder"></i></div>
                  <h4 class="project-card-title">{{ project.name }}</h4>
                </div>
              </div>
              <div class="project-card-body">
                <div class="project-placeholder">
                  <i class="fas fa-tools"></i>
                  <p>{{ project.description|default:"Coming soon" }}</p>
                </div>
              </div>
            </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="project-placeholder" style="padding: 3rem;">
              <i class="fas fa-folder-open" style="font-size: 3rem;"></i>
              <p>No projects assigned yet</p>
              <small>Contact your administrator to get access to projects</small>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- RIGHT: Action Requests -->
      <div class="action-requests-panel">
        <h3 class="panel-title"><i class="fas fa-tasks"></i> Action Requests</h3>
        <div class="action-requests-list">
          {% if all_action_requests %}
            {% for req in all_action_requests %}
            <div class="action-request-card project-{{ req.project|lower }}">
              <div class="action-request-header">
                <span class="action-request-type"><i class="fas {{ req.icon }}"></i> {{ req.type_label }}</span>
                <span class="action-request-project {% if req.project == 'CGF' %}cgf{% endif %}">{{ req.project }}</span>
              </div>
              <div class="action-request-detail">{{ req.detail }}</div>
              <div class="action-request-footer">
                <span class="action-request-date">{{ req.created_at|date:"M d, Y" }}</span>
                <span class="action-request-status {{ req.status }}">{{ req.status_display }}</span>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="action-requests-empty">
              <i class="fas fa-inbox"></i>
              No action requests yet
              <div style="font-size: 0.8rem; margin-top: 0.5rem;">Requests from 52WSC and CGF will appear here</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Edit Personal Information Modal -->
    <div id="editPersonalModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-user-edit"></i> Edit Personal Information</h3>
          <button type="button" class="modal-close" onclick="closeEditPersonalModal()">&times;</button>
        </div>
        <form method="post" enctype="multipart/form-data" id="editPersonalForm">
          {% csrf_token %}
          <input type="hidden" name="bank_name" value="{{ user.profile.bank_name|default:'' }}">
          <input type="hidden" name="bank_account_number" value="{{ user.profile.bank_account_number|default:'' }}">
          <input type="hidden" name="bank_account_name" value="{{ user.profile.bank_account_name|default:'' }}">
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" value="{{ user.email }}" required>
              </div>
              <div class="form-group">
                <label class="form-label">WhatsApp Number <span style="color: #dc2626;">*</span></label>
                <input type="tel" class="form-control" name="whatsapp_number" value="{{ user.profile.whatsapp_number|default:'' }}" placeholder="+2567XXXXXXXX" required>
              </div>
              <div class="form-group">
                <label class="form-label">National ID</label>
                <input type="text" class="form-control" name="national_id" value="{{ user.profile.national_id|default:'' }}" placeholder="National ID Number">
              </div>
              <div class="form-group full-width">
                <label class="form-label">Address</label>
                <textarea class="form-control" name="address" placeholder="Your address">{{ user.profile.address|default:'' }}</textarea>
              </div>
              <div class="form-group full-width">
                <label class="form-label">Bio</label>
                <textarea class="form-control" name="bio" placeholder="Tell us about yourself">{{ user.profile.bio|default:'' }}</textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Date of Birth</label>
                <input type="date" class="form-control" name="birthdate" value="{{ user.profile.birthdate|date:'Y-m-d'|default:'' }}">
              </div>
              <div class="form-group">
                <label class="form-label">Profile Photo</label>
                <input type="file" class="form-control" name="photo" accept="image/*">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeEditPersonalModal()">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Bank Details Modal -->
    <div id="editBankModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-university"></i> Edit Bank Account Details</h3>
          <button type="button" class="modal-close" onclick="closeEditBankModal()">&times;</button>
        </div>
        <form method="post" enctype="multipart/form-data" id="editBankForm">
          {% csrf_token %}
          <input type="hidden" name="first_name" value="{{ user.first_name }}">
          <input type="hidden" name="last_name" value="{{ user.last_name }}">
          <input type="hidden" name="email" value="{{ user.email }}">
          <input type="hidden" name="whatsapp_number" value="{{ user.profile.whatsapp_number|default:'' }}">
          <input type="hidden" name="national_id" value="{{ user.profile.national_id|default:'' }}">
          <input type="hidden" name="address" value="{{ user.profile.address|default:'' }}">
          <input type="hidden" name="bio" value="{{ user.profile.bio|default:'' }}">
          <input type="hidden" name="birthdate" value="{{ user.profile.birthdate|date:'Y-m-d'|default:'' }}">
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" name="bank_name" value="{{ user.profile.bank_name|default:'' }}" placeholder="e.g., Centenary Bank, Stanbic Bank">
              </div>
              <div class="form-group">
                <label class="form-label">Account Number</label>
                <input type="text" class="form-control" name="bank_account_number" value="{{ user.profile.bank_account_number|default:'' }}" placeholder="Your bank account number">
              </div>
              <div class="form-group full-width">
                <label class="form-label">Account Name</label>
                <input type="text" class="form-control" name="bank_account_name" value="{{ user.profile.bank_account_name|default:'' }}" placeholder="Name as it appears on your bank account">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeEditBankModal()">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-money-bill-wave"></i>
          Request Withdrawal
        </h3>
        <button class="modal-close" onclick="closeWithdrawModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="withdrawForm" method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="withdraw">
          
            <div class="form-group">
              <label class="form-label">Available Balance</label>
              <input type="text" class="form-control" value="UGX {{ user.profile.get_available_balance|default:0|floatformat:0|intcomma }}" readonly>
              <div class="form-help">Amount available for withdrawal (after deducting pending requests)</div>
            </div>
          
          <div class="form-group">
            <label class="form-label">Withdrawal Amount (UGX)</label>
            <input type="number" class="form-control" name="withdraw_amount" min="1000" step="1000" required placeholder="Enter amount">
            <div class="form-help">Minimum withdrawal: UGX 1,000</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Reason (Optional)</label>
            <textarea class="form-control" name="withdraw_reason" rows="3" placeholder="Reason for withdrawal"></textarea>
          </div>
          
          <div class="info-card" style="margin-top: 1rem;">
            <h4 style="color: var(--brand-d); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-info-circle"></i>
              Important
            </h4>
            <p style="color: #9a3412; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              Please ensure your bank account details are up to date in your profile. Withdrawals are subject to admin approval and may take 1-3 business days to process.
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeWithdrawModal()">Cancel</button>
        <button type="submit" form="withdrawForm" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i>
          Submit Request
        </button>
      </div>
    </div>
  </div>

  <!-- Join GWC Modal -->
  <div id="gwcModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-users"></i>
          Join GWC Group
        </h3>
        <button class="modal-close" onclick="closeGWCModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="gwcForm" method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="join_gwc">
          
            <div class="form-group">
              <label class="form-label">Available Balance</label>
              <input type="text" class="form-control" value="UGX {{ user.profile.get_available_balance|default:0|floatformat:0|intcomma }}" readonly>
              <div class="form-help">Amount available for withdrawal (after deducting pending requests)</div>
            </div>
          
          <div class="form-group">
            <label class="form-label">Contribution Amount (UGX)</label>
            <input type="number" class="form-control" name="gwc_amount" min="1000" step="1000" required placeholder="Enter contribution amount">
            <div class="form-help">Minimum contribution: UGX 1,000</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Group Type</label>
            <select class="form-control" name="gwc_group_type" required>
              <option value="">Select group type</option>
              <option value="individual">Individual Contribution</option>
              <option value="group">Group Contribution</option>
            </select>
            <div class="form-help">Choose how you want to contribute</div>
          </div>
          
          <div class="info-card" style="margin-top: 1rem;">
            <h4 style="color: var(--brand-d); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-info-circle"></i>
              About GWC
            </h4>
            <p style="color: #9a3412; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              Generational Wealth Creation (GWC) groups help members build wealth together. Your contribution will be used to join or create a GWC group. Minimum group target is UGX 120,000,000.
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeGWCModal()">Cancel</button>
        <button type="submit" form="gwcForm" class="btn btn-primary">
          <i class="fas fa-users"></i>
          Join Group
        </button>
      </div>
    </div>
  </div>

  <!-- Buy MESU Shares Modal -->
  <div id="mesuModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-graduation-cap"></i>
          Buy MESU Academy Shares
        </h3>
        <button class="modal-close" onclick="closeMESUModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="mesuForm" method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="buy_mesu">
          
            <div class="form-group">
              <label class="form-label">Available Balance</label>
              <input type="text" class="form-control" value="UGX {{ user.profile.get_available_balance|default:0|floatformat:0|intcomma }}" readonly>
              <div class="form-help">Amount available for withdrawal (after deducting pending requests)</div>
            </div>
          
          <div class="form-group">
            <label class="form-label">Investment Amount (UGX)</label>
            <input type="number" class="form-control" name="mesu_amount" id="mesuAmount" min="1000000" step="1000000" required placeholder="Enter investment amount (multiples of 1,000,000)">
            <div class="form-help">Minimum investment: UGX 1,000,000 (1 share). Each share costs UGX 1,000,000</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Number of Shares</label>
            <input type="number" class="form-control" name="mesu_shares" id="mesuShares" min="1" step="1" placeholder="Will be calculated automatically" readonly>
            <div class="form-help">Number of shares will be calculated automatically (1 share = UGX 1,000,000)</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Additional Notes (Optional)</label>
            <textarea class="form-control" name="mesu_notes" rows="3" placeholder="Any additional information or questions"></textarea>
          </div>
          
          <div class="info-card" style="margin-top: 1rem;">
            <h4 style="color: var(--brand-d); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-info-circle"></i>
              About MESU Academy
            </h4>
            <p style="color: #9a3412; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              MESU Academy offers investment opportunities through share purchases. Each share costs UGX 1,000,000. Your investment will be held pending admin approval. Once approved, the amount will be deducted from your savings.
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeMESUModal()">Cancel</button>
        <button type="submit" form="mesuForm" class="btn btn-primary">
          <i class="fas fa-graduation-cap"></i>
          Express Interest
        </button>
      </div>
    </div>
  </div>

  <!-- CGF: Sell & Cash Out Modal -->
  <div id="cgfSellModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-hand-holding-usd"></i> Sell & Cash Out</h3>
        <button type="button" class="modal-close" onclick="closeCGFSellModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="cgfSellForm" method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="cgf_sell_cash_out">
          <div class="form-group">
            <label class="form-label">Goats Available</label>
            <input type="text" class="form-control" value="{{ cgf_goats_available|default:0 }} goats" readonly>
            <div class="form-help">Total goats at end of cycle minus any pending requests</div>
          </div>
          <div class="form-group">
            <label class="form-label">Number of Goats to Sell</label>
            <input type="number" class="form-control" name="cgf_goats_count" id="cgfSellGoatsCount" min="1" max="{{ cgf_goats_available|default:0 }}" step="1" required placeholder="Enter number">
          </div>
          <div class="form-group">
            <label class="form-label">Cash Value</label>
            <div class="form-control" style="background: #f8fafc; font-weight: 600;" id="cgfSellValueDisplay">UGX 0</div>
            <div class="form-help">UGX {{ cgf_goat_sell_price|default:400000|floatformat:0|intcomma }} per goat</div>
          </div>
          <div class="form-group" id="cgfSellRemainingGroup">
            <label class="form-label">Remaining for Take Goats / Transfer</label>
            <div class="form-control" style="background: #f0fdf4; font-weight: 600; color: #166534;" id="cgfSellRemainingDisplay">{{ cgf_goats_available|default:0 }} goats</div>
          </div>
          <div class="form-group">
            <label class="form-label">Additional Details (Optional)</label>
            <textarea class="form-control" name="cgf_notes" rows="3" placeholder="e.g. Preferred timeline, any special requests..."></textarea>
          </div>
          <div class="info-card" style="margin-top: 1rem;">
            <p style="color: #9a3412; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              Ensure your bank account details are up to date in your profile for payments. Admin will review and process your request.
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeCGFSellModal()">Cancel</button>
        <button type="submit" form="cgfSellForm" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Request</button>
      </div>
    </div>
  </div>

  <!-- CGF: Take Goats Modal -->
  <div id="cgfTakeGoatsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-truck-loading"></i> Take Goats</h3>
        <button type="button" class="modal-close" onclick="closeCGFTakeGoatsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="cgfTakeGoatsForm" method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="cgf_take_goats">
          <div class="form-group">
            <label class="form-label">Goats Available</label>
            <input type="text" class="form-control" value="{{ cgf_goats_available|default:0 }} goats" readonly>
            <div class="form-help">Remaining after any pending sell/transfer requests</div>
          </div>
          <div class="form-group">
            <label class="form-label">Number of Goats to Take</label>
            <input type="number" class="form-control" name="cgf_goats_count" id="cgfTakeGoatsCount" min="1" max="{{ cgf_goats_available|default:0 }}" step="1" required placeholder="Enter number">
          </div>
          <div class="form-group" id="cgfTakeRemainingGroup">
            <label class="form-label">Remaining for Sell / Transfer</label>
            <div class="form-control" style="background: #f0fdf4; font-weight: 600; color: #166534;" id="cgfTakeRemainingDisplay">{{ cgf_goats_available|default:0 }} goats</div>
          </div>
          <div class="form-group">
            <label class="form-label">Additional Details (Optional)</label>
            <textarea class="form-control" name="cgf_notes" rows="3" placeholder="e.g. Preferred collection date, farm location..."></textarea>
          </div>
          <div class="info-card" style="margin-top: 1rem;">
            <p style="color: #9a3412; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              Admin will coordinate pickup/collection with you.
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeCGFTakeGoatsModal()">Cancel</button>
        <button type="submit" form="cgfTakeGoatsForm" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Request</button>
      </div>
    </div>
  </div>

  <!-- CGF: Transfer (Breeding → Commercial) Modal -->
  <div id="cgfTransferModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-exchange-alt"></i> Transfer (Breeding → Commercial)</h3>
        <button type="button" class="modal-close" onclick="closeCGFTransferModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="cgfTransferForm" method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="cgf_transfer">
          <div class="form-group">
            <label class="form-label">Goats Available</label>
            <input type="text" class="form-control" value="{{ cgf_goats_available|default:0 }} goats" readonly>
            <div class="form-help">Remaining after any pending sell/take requests</div>
          </div>
          <div class="form-group">
            <label class="form-label">Number of Goats to Transfer</label>
            <input type="number" class="form-control" name="cgf_goats_count" id="cgfTransferGoatsCount" min="1" max="{{ cgf_goats_available|default:0 }}" step="1" required placeholder="Enter number">
          </div>
          <div class="form-group" id="cgfTransferRemainingGroup">
            <label class="form-label">Remaining for Sell / Take</label>
            <div class="form-control" style="background: #f0fdf4; font-weight: 600; color: #166534;" id="cgfTransferRemainingDisplay">{{ cgf_goats_available|default:0 }} goats</div>
          </div>
          <div class="form-group">
            <label class="form-label">Additional Details (Optional)</label>
            <textarea class="form-control" name="cgf_notes" rows="3" placeholder="e.g. Source farm, target farm..."></textarea>
          </div>
          <div class="info-card" style="margin-top: 1rem;">
            <p style="color: #9a3412; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              Transfer goats from breeding farm to commercial farm. Admin will process the transfer.
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeCGFTransferModal()">Cancel</button>
        <button type="submit" form="cgfTransferForm" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Request</button>
      </div>
    </div>
  </div>

  <script>
    // Toggle user dropdown
    function toggleDropdown() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('userDropdown');
      const userButton = event.target.closest('.user-button');
      
      if (!userButton) {
        dropdown.classList.remove('show');
      }
    });

    // Reset form to original values
    function resetForm() {
      if (confirm('Are you sure you want to reset all changes?')) {
        location.reload();
      }
    }

    // Accordion toggle
    function toggleAccordion(header) {
      const section = header.closest('.accordion-section');
      const content = section.querySelector('.accordion-content');
      const isOpen = content.classList.contains('show');
      document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('show'));
      document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));
      if (!isOpen) {
        content.classList.add('show');
        header.classList.add('active');
      }
    }

    // Edit modals
    function openEditPersonalModal() {
      document.getElementById('editPersonalModal').classList.add('show');
    }
    function closeEditPersonalModal() {
      document.getElementById('editPersonalModal').classList.remove('show');
    }
    function openEditBankModal() {
      document.getElementById('editBankModal').classList.add('show');
    }
    function closeEditBankModal() {
      document.getElementById('editBankModal').classList.remove('show');
    }

    // Modal functions
    function openWithdrawModal() {
      document.getElementById('withdrawModal').classList.add('show');
    }

    function closeWithdrawModal() {
      document.getElementById('withdrawModal').classList.remove('show');
    }

    function openGWCModal() {
      document.getElementById('gwcModal').classList.add('show');
    }

    function closeGWCModal() {
      document.getElementById('gwcModal').classList.remove('show');
    }

    function openMESUModal() {
      document.getElementById('mesuModal').classList.add('show');
    }

    function closeMESUModal() {
      document.getElementById('mesuModal').classList.remove('show');
    }

    function openCGFSellModal() {
      document.getElementById('cgfSellModal').classList.add('show');
    }
    function closeCGFSellModal() {
      document.getElementById('cgfSellModal').classList.remove('show');
    }
    function openCGFTakeGoatsModal() {
      document.getElementById('cgfTakeGoatsModal').classList.add('show');
    }
    function closeCGFTakeGoatsModal() {
      document.getElementById('cgfTakeGoatsModal').classList.remove('show');
    }
    function openCGFTransferModal() {
      document.getElementById('cgfTransferModal').classList.add('show');
    }
    function closeCGFTransferModal() {
      document.getElementById('cgfTransferModal').classList.remove('show');
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const withdrawModal = document.getElementById('withdrawModal');
      const gwcModal = document.getElementById('gwcModal');
      const mesuModal = document.getElementById('mesuModal');
      const cgfSellModal = document.getElementById('cgfSellModal');
      const cgfTakeGoatsModal = document.getElementById('cgfTakeGoatsModal');
      const cgfTransferModal = document.getElementById('cgfTransferModal');
      const editPersonalModal = document.getElementById('editPersonalModal');
      const editBankModal = document.getElementById('editBankModal');
      
      if (event.target == withdrawModal) closeWithdrawModal();
      if (event.target == gwcModal) closeGWCModal();
      if (event.target == mesuModal) closeMESUModal();
      if (event.target == cgfSellModal) closeCGFSellModal();
      if (event.target == cgfTakeGoatsModal) closeCGFTakeGoatsModal();
      if (event.target == cgfTransferModal) closeCGFTransferModal();
      if (event.target == editPersonalModal) closeEditPersonalModal();
      if (event.target == editBankModal) closeEditBankModal();
    }

    // Calculate MESU shares automatically (1 share = 1,000,000 UGX)
    // CGF Sell: update cash value when goats count changes
    document.addEventListener('DOMContentLoaded', function() {
      const mesuAmountInput = document.getElementById('mesuAmount');
      const mesuSharesInput = document.getElementById('mesuShares');
      
      if (mesuAmountInput && mesuSharesInput) {
        mesuAmountInput.addEventListener('input', function() {
          const amount = parseFloat(this.value) || 0;
          const shares = Math.floor(amount / 1000000);
          mesuSharesInput.value = shares;
        });
      }

      const cgfGoatsAvailable = {{ cgf_goats_available|default:0 }};
      const cgfGoatPrice = {{ cgf_goat_sell_price|default:400000 }};
      const cgfSellGoatsInput = document.getElementById('cgfSellGoatsCount');
      const cgfSellValueDisplay = document.getElementById('cgfSellValueDisplay');
      const cgfSellRemainingDisplay = document.getElementById('cgfSellRemainingDisplay');
      const cgfTakeGoatsInput = document.getElementById('cgfTakeGoatsCount');
      const cgfTakeRemainingDisplay = document.getElementById('cgfTakeRemainingDisplay');
      const cgfTransferGoatsInput = document.getElementById('cgfTransferGoatsCount');
      const cgfTransferRemainingDisplay = document.getElementById('cgfTransferRemainingDisplay');

      if (cgfSellGoatsInput && cgfSellValueDisplay) {
        function updateCgfSellDisplay() {
          const goats = parseInt(cgfSellGoatsInput.value, 10) || 0;
          const value = goats * cgfGoatPrice;
          const remaining = Math.max(0, cgfGoatsAvailable - goats);
          cgfSellValueDisplay.textContent = 'UGX ' + value.toLocaleString('en-UG', { maximumFractionDigits: 0 });
          if (cgfSellRemainingDisplay) cgfSellRemainingDisplay.textContent = remaining + ' goats';
        }
        cgfSellGoatsInput.addEventListener('input', updateCgfSellDisplay);
        cgfSellGoatsInput.addEventListener('change', updateCgfSellDisplay);
        updateCgfSellDisplay();
      }
      if (cgfTakeGoatsInput && cgfTakeRemainingDisplay) {
        function updateCgfTakeDisplay() {
          const goats = parseInt(cgfTakeGoatsInput.value, 10) || 0;
          const remaining = Math.max(0, cgfGoatsAvailable - goats);
          cgfTakeRemainingDisplay.textContent = remaining + ' goats';
        }
        cgfTakeGoatsInput.addEventListener('input', updateCgfTakeDisplay);
        cgfTakeGoatsInput.addEventListener('change', updateCgfTakeDisplay);
        updateCgfTakeDisplay();
      }
      if (cgfTransferGoatsInput && cgfTransferRemainingDisplay) {
        function updateCgfTransferDisplay() {
          const goats = parseInt(cgfTransferGoatsInput.value, 10) || 0;
          const remaining = Math.max(0, cgfGoatsAvailable - goats);
          cgfTransferRemainingDisplay.textContent = remaining + ' goats';
        }
        cgfTransferGoatsInput.addEventListener('input', updateCgfTransferDisplay);
        cgfTransferGoatsInput.addEventListener('change', updateCgfTransferDisplay);
        updateCgfTransferDisplay();
      }
    });

    // Notification System
    function showNotification(type, message, title = null) {
      const container = document.getElementById('notificationContainer');
      if (!container) return;

      // Determine icon and default title based on type
      const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
      };

      const defaultTitles = {
        'success': 'Success!',
        'error': 'Error',
        'warning': 'Warning',
        'info': 'Information'
      };

      const icon = icons[type] || icons.info;
      const notificationTitle = title || defaultTitles[type] || 'Notification';

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas ${icon} notification-icon"></i>
        <div class="notification-content">
          <div class="notification-title">${notificationTitle}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button type="button" class="notification-close" onclick="closeNotification(this)">
          <i class="fas fa-times"></i>
        </button>
        <div class="notification-progress"></div>
      `;

      container.appendChild(notification);

      // Auto-remove after 10 seconds
      setTimeout(() => {
        closeNotification(notification.querySelector('.notification-close'));
      }, 10000);
    }

    function closeNotification(button) {
      const notification = button.closest('.notification');
      if (notification) {
        notification.classList.add('hiding');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }
    }

    // Enhanced success notifications for specific actions
    document.addEventListener('DOMContentLoaded', function() {
      // Check URL parameters for action success
      const urlParams = new URLSearchParams(window.location.search);
      const action = urlParams.get('action');
      
      if (action === 'withdraw_success') {
        const amount = urlParams.get('amount') || '';
        showNotification('success', 
          `Your withdrawal request of UGX ${amount} has been submitted successfully! The admin will process it within 1-3 business days.`,
          'Withdrawal Request Submitted'
        );
      } else if (action === 'gwc_success') {
        const amount = urlParams.get('amount') || '';
        const type = urlParams.get('type') || '';
        showNotification('success',
          `Your GWC contribution request of UGX ${amount} (${type}) has been submitted successfully! Admin will review your request.`,
          'GWC Contribution Submitted'
        );
      } else if (action === 'mesu_success') {
        const shares = urlParams.get('shares') || '';
        const amount = urlParams.get('amount') || '';
        showNotification('success',
          `Your interest in MESU shares (${shares} share(s) = UGX ${amount}) has been submitted successfully! Admin will review your request.`,
          'MESU Investment Interest Submitted'
        );
      } else if (action === 'cgf_request_success') {
        const type = urlParams.get('type') || '';
        const labels = { sell_cash_out: 'Sell & Cash Out', take_goats: 'Take Goats', transfer: 'Transfer (Breeding → Commercial)' };
        const label = labels[type] || type;
        showNotification('success',
          `Your ${label} request has been submitted successfully! Admin will review and process it.`,
          'CGF Action Request Submitted'
        );
      }
      
      // Make 52WSC project items clickable
      const clickableProjects = document.querySelectorAll('.project-item.clickable');
      clickableProjects.forEach(project => {
        project.addEventListener('click', function() {
          const link = this.querySelector('a');
          if (link) {
            window.location.href = link.href;
          }
        });
      });
    });
  </script>
</body>
</html>
